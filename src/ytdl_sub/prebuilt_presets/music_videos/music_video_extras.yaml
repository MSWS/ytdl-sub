#
# Kodi Music Videos with Extras:
#   + Rick Astley:
#     Music Videos:
#       - url1
#       - url2
#       ...
#     Concerts:
#       - "Custom Title | 2013 | url3"
#       - url4
#     Extras:
#       - url5
#       - url6
#     Behind The Scenes:
#       - ...
#     Live:
#       - ...
#     Lyrics:
#       - ...

presets:
  _music_video_extras_base:
    preset:
      - "_music_video_base"

    overrides:

      # Splits metadata values from (TODO: allow any whitespace between | )
      # Key:
      #   - metadata_0 | url
      #   - metadata_0 | metadata_1 | url
      "%get_value_split": >-
        { %split($0, " | ") }

      # Gets the size of the metadata split
      "%get_value_size": >-
        { %array_size( %get_value_split($0) ) }

      # Gets the URL from the metadata, will always be the last one
      "%get_value_url": >-
        { %array_at( %get_value_split($0), -1 ) }

      # gets metadata_i if present, otherwise returns null
      "%get_value_metadata_i": >-
        {
          %if(
            %gt( %get_value_size($0) , %add($1, 1) ),
            %array_at( %get_value_split($0), $1 ),
            null
          )
        }

      # For each value under a key, build this map allowing up to 5 metadata values
      "%get_value_metadata_map": >-
        {
          {
            "key": $1,
            "url": %get_value_url($0),
            0: %get_value_metadata_i($0, 0),
            1: %get_value_metadata_i($0, 1),
            2: %get_value_metadata_i($0, 2),
            3: %get_value_metadata_i($0, 3),
            4: %get_value_metadata_i($0, 4)
          }
        }

      # TODO: Have this support single-string values
      "%get_value_metadata_map_outer": >-
        { %array_apply_fixed( $1, $0, %get_value_metadata_map ) }

      # Build an array of metadata maps from every key in the subscription_map
      subscription_list_of_maps: >-
        {
          %array_flatten(
            %map_apply( subscription_map, %get_value_metadata_map_outer )
          )
        }

      "%get_list_metadata_field_by_idx": >-
        {
          %map_get(
            %array_at( subscription_list_of_maps, $0, {} ),
            $1,
            $2
          )
        }

      "%get_url_by_idx": >-
        { %get_list_metadata_field_by_idx($0, "url", null) }
      "%get_key_by_idx": >-
        { %get_list_metadata_field_by_idx($0, "key", null) }
      "%get_metadata_i_by_idx": >-
        { %get_list_metadata_field_by_idx($0, $1, $2) }

      metadata_0_default: "{ %string(null) }"
      metadata_1_default: "{ %string(null) }"
      metadata_2_default: "{ %string(null) }"
      metadata_3_default: "{ %string(null) }"
      metadata_4_default: "{ %string(null) }"


    download:
      - url: "{ %get_url_by_idx(0) }"
        playlist_thumbnails:
          - name: "{avatar_uncropped_thumbnail_file_name}"
            uid: "avatar_uncropped"
          - name: "{banner_uncropped_thumbnail_file_name}"
            uid: "banner_uncropped"
        variables:
          metadata_key: "{ %get_key_by_idx(0) }"
          metadata_0: "{ %get_metadata_i_by_idx(0, 0, metadata_0_default) }"
          metadata_1: "{ %get_metadata_i_by_idx(0, 1, metadata_1_default) }"
          metadata_2: "{ %get_metadata_i_by_idx(0, 2, metadata_2_default) }"
          metadata_3: "{ %get_metadata_i_by_idx(0, 3, metadata_3_default) }"
          metadata_4: "{ %get_metadata_i_by_idx(0, 4, metadata_4_default) }"
      - url: "{ %get_url_by_idx(1) }"
        variables:
          metadata_key: "{ %get_key_by_idx(1) }"
          metadata_0: "{ %get_metadata_i_by_idx(0, 0, metadata_0_default) }"
          metadata_1: "{ %get_metadata_i_by_idx(0, 1, metadata_1_default) }"
          metadata_2: "{ %get_metadata_i_by_idx(0, 2, metadata_2_default) }"
          metadata_3: "{ %get_metadata_i_by_idx(0, 3, metadata_3_default) }"
          metadata_4: "{ %get_metadata_i_by_idx(0, 4, metadata_4_default) }"

  "Jellyfin Music Videos with Extras":
    preset:
      - "_base"
      - "_music_video_extras_base"
      - "_music_video_nfo"
      - "_music_video_tags"

  "Kodi Music Videos with Extras":
    preset:
      - "_kodi_base"
      - "_music_video_extras_base"
      - "_music_video_nfo"
      - "_music_video_tags"

  "Plex Music Videos with Extras":
    preset:
      - "_plex_video_base"
      - "_music_video_extras_base"
      - "_music_video_tags"

    overrides:
      metadata_verify_plex_suffix: "{url_metadata}"
      music_video_file_name_suffix: "-{music_video_album}"